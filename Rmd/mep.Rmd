---
title: ''
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)
Sys.setenv(np = parallel::detectCores())
```

```{bash}
ffidx.py "../data/genbank/10508.db" -entry "FJ643676.1" -fo gb | \
  ffcds.py - | \
  ffidx.py - -entry "ACU57015.1" | \
  blastn -db ../data/blast/10508 -outfmt "7 std qlen staxid" -subject_besthit -num_threads "$np" > \
  hits.tsv
```

```{r}
fields <- c(
  qaccver = "c", saccver = "c", 
  pident = "d", length = "i", mismatch = "i", gapopen = "i", 
  qstart = "i", qend = "i", sstart = "i", send = "i", 
  evalue = "d", bitscore = "i", 
  qlen = "i", staxid = "i"
)
df.hits <- read_tsv(
  "hits.tsv", 
  col_names = names(fields), 
  col_types = paste(fields, collapse = ""), 
  comment = "#"
)
df.meta <- read_tsv("../data/genbank/10508.tsv", col_types = "ccfDfff", na = "?")
```

```{r}
group_by(df.hits, saccver) %>%
  summarise(
    qpidcov = (sum(length) - sum(gapopen) - sum(mismatch)) / sum(qlen) * 100,
    sstart = min(sstart, send),
    send = max(sstart, send),
    staxid = staxid,
    .groups = "drop"
  ) %>%
  filter(qpidcov >= 90) %>%
  left_join(df.meta, c(saccver = "accver")) %>%
  filter(!is.na(date)) %>%
  arrange(date) %>%
  write_tsv("agg.tsv") ->
  df.agg
```

```{r}
with(df.agg, write_lines(sprintf("%s %d-%d", saccver, sstart, send), "ebat.ssv"))
```

```{bash}
blastdbcmd -db ../data/blast/10508 -entry_batch ebat.ssv | \
  sed '/^>/ s/:.*//' | 
  mafft --auto --adjustdirection --thread -1 - > msa.fna 2> msa.log
```

```{r}
ape::read.dna("msa.fna", format = "fasta", as.character = T, as.matrix = T) %>%
  apply(1, function(ele) {
    ele <- paste(ele, collapse = "")
    sum(str_length(str_match(ele, "^-+")), str_length(str_match(ele, "^-+$")), na.rm = T)
  }) -> gaps
```

```{bash}
run_gubbins.py msa.fna -i 1000 -p gub -c "$np" > gub.log
```

```{r}
path <- "gub.recombination_predictions.gff"

ape::read.gff(path) %>%
  # collapse overlapping ranges: https://stackoverflow.com/a/41748023
  arrange(start) %>%
  group_by(g = cumsum(cummax(lag(end, default = first(end))) < start)) %>% 
  summarise(start = first(start), end = max(end), .groups = "drop") %>%
  mutate(start = start - 1, end = end) ->
  df.block

read_lines(path) %>%
  .[grep("^##sequence-region ", .)] %>%
  str_split_fixed(" ", 4) %>% 
  .[ , 4] %>% 
  as.integer() -> 
  nchar

pivot_longer(df.block, c("start", "end")) %>%
  with(unique(c(0, value, nchar))) ->
  idx

write_tsv(bind_rows(lapply(df.agg$saccver[gaps == 0], function(ele)
  data.frame(
    chrom = ele, chromStart = 0, chromEnd = nchar, name = ele,
    score = 0, strand = ".", thickStart = 0, thickEnd = 0, itemRgb = 0,
    blockCount = length(idx) / 2,
    blockSizes = paste(idx[c(F, T)] - idx[c(T, F)], collapse = ","),
    blockStarts = paste(idx[c(T, F)], collapse = ",")
  )
)), "msa.bed", col_names = F)
```

```{bash}
bedtools getfasta -fi msa.fna -bed msa.bed -split -name | \
  sed '/^>/ s/:.*//' > \
  ext.fna
```

```{bash}
rm phy.* && \
  iqtree -s ext.fna -pre phy -alrt 1000 -bb 1000 -bnni -nt AUTO > /dev/null 2> /dev/null
```
