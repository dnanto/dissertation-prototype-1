---
title: "mep"
date: !r format(Sys.time(), "%B %d, %Y")
output: html_document
params:
  acc: "FJ643676.1"
  pid: ""
  fdb: "/Users/dnanto/GitHub/dissertation/data/genbank/10508.db"
  bdb: "/Users/dnanto/GitHub/dissertation/data/blast/10508"
  tsv: "/Users/dnanto/GitHub/dissertation/data/genbank/10508.tsv"
  thr: 85
  itr: 10
  cpu: !r parallel::detectCores()
  out: "/Users/dnanto/GitHub/dissertation/out/gen"
---

```{r setup}
suppressPackageStartupMessages({
  library(tidyverse)
  library(ggtree)
  library(lubridate)
  library(BactDating)
})
knitr::opts_chunk$set(echo = T)
do.call(Sys.setenv, params)
dir.create(params$out, showWarnings = F, recursive = T)
```

```{r}
enframe(unlist(params), "key", "val")
```

```{bash}
cd "$out" || exit

if [[ $pid ]]; then
  python -m ffbio.ffidx "$fdb" -entry "$acc" -fo gb | \
    python -m ffbio.ffcds - | \
    python -m ffbio.ffidx - -entry "$pid" > \
    ref.fna
else
  python -m ffbio.ffidx "$fdb" -entry "$acc" > ref.fna
fi

blastn \
  -task megablast \
  -db "$bdb" \
  -query ref.fna \
  -outfmt "7 std qlen stitle" \
  -num_threads "$cpu" \
  -subject_besthit > \
  hits.tsv
```

```{r}
fields <- c(
  qaccver = "c", saccver = "c", 
  pident = "d", length = "i", mismatch = "i", gapopen = "i", 
  qstart = "i", qend = "i", sstart = "i", send = "i", 
  evalue = "d", bitscore = "i", 
  qlen = "i", stitle = "c"
)
df.hits <- read_tsv(
  file.path(params$out, "hits.tsv"), 
  col_names = names(fields), 
  col_types = paste(fields, collapse = ""), 
  comment = "#"
)

df.meta <- read_tsv(params$tsv, col_types = cols(date = "D", .default = "c"), na = "?")

group_by(df.hits, saccver) %>%
  summarise(
    qpidcov = (sum(length) - sum(gapopen) - sum(mismatch)) / first(qlen) * 100,
    sstart = min(sstart, send),
    send = max(sstart, send),
    staxid = first(staxid),
    stitle = first(stitle),
    .groups = "drop"
  ) %>%
  filter(qpidcov >= params$thr) %>%
  left_join(df.meta, c(saccver = "accver")) %>%
  filter(!is.na(date)) %>%
  arrange(date) %>%
  write_tsv(file.path(params$out, "meta.tsv")) ->
  df.meta

with(df.meta, {
  write_lines(sprintf("%s %d-%d", saccver, sstart, send), file.path(params$out, "ebat.ssv"))
})
```

```{bash}
cd "$out" || exit && \
blastdbcmd -db "$bdb" -entry_batch ebat.ssv | \
  sed -e "s/:.*//" | \
  mafft --auto --adjustdirection --thread "$cpu" - 2> msa.log | \
  # convert ambiguous bases and non-gap characters to N
  sed "/^[^>]/ s/[^ACGTNacgtn]/n/g" > \
  msa.fna && \
run_gubbins.py msa.fna -i "$itr" -p gub -c "$cpu" > gub.log && \
rm -rf iqt.* && \
iqtree -pre iqt -s msa.fna -m TESTONLY -nt "$cpu"
```

